name: CD
on:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  id-token: write

jobs:
  cd:
    name: "NPM Release"
    environment: NPM
    runs-on: ubuntu-latest
    env:
      commit: "chore: update versions"
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup
        with:
          save-cache: "true"
      - name: Generate a token
        id: generate-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.GH_APP_ID }}
          private-key: ${{ secrets.GH_APP_PRIVATE_KEY }}
          owner: eternal-baguette
          repositories: "ui-kit"
      - name: Setup Git user
        run: |
          git config --global user.name '${{ steps.generate-token.outputs.app-slug }}[bot]'
          git config --global user.email '${{ vars.GH_APP_UID }}+${{ steps.generate-token.outputs.app-slug }}[bot]@users.noreply.github.com'
      - name: Create and publish versions
        id: changeset
        uses: changesets/action@v1
        with:
          commit: ${{ env.commit }}
          title: ${{ env.commit }}
          publish: pnpm ci:publish
        env:
          GITHUB_TOKEN: ${{ steps.generate-token.outputs.token }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }} # Temporary, to be replaced by NPM TP after first publish
      - name: Checkout PR branch
        if: steps.changeset.outputs.pullRequestNumber != ''
        run: gh pr checkout ${{ steps.changeset.outputs.pullRequestNumber }}
      - name: Extract commit information
        if: steps.changeset.outputs.pullRequestNumber != ''
        id: git-info
        run: |
          echo "head-sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          echo "tree-sha=$(git rev-parse HEAD^{tree})" >> $GITHUB_OUTPUT
          echo "parent-sha=$(git rev-parse HEAD~1)" >> $GITHUB_OUTPUT
      - name: Doctor commit with signature
        if: steps.changeset.outputs.pullRequestNumber != ''
        uses: actions/github-script@v8
        env:
          PR_NUMBER: ${{ steps.changeset.outputs.pullRequestNumber }}
          TREE_SHA: ${{ steps.git-info.outputs.tree-sha }}
          HEAD_SHA: ${{ steps.git-info.outputs.head-sha }}
          PARENT_SHA: ${{ steps.git-info.outputs.parent-sha }}
          COMMIT_MESSAGE: ${{ env.commit }}
          HEAD_REF: "changeset-release/main"
        with:
          github-token: ${{ steps.generate-token.outputs.token }}
          script: |
            const prNumber = process.env.PR_NUMBER;
            const headSha = process.env.HEAD_SHA;
            const treeSha = process.env.TREE_SHA;
            const commitMessage = process.env.COMMIT_MESSAGE;
            const parentSha = process.env.PARENT_SHA;
            const headRef = process.env.HEAD_REF;
            
            core.info(`Original commit: ${headSha}`);
            core.info(`Tree SHA: ${treeSha}`);
            core.info(`Message: ${commitMessage}`);
            core.info(`Parent: ${parentSha}`);
            
            // Create a new signed commit with the same tree
            const { data: newCommit } = await github.rest.git.createCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              message: commitMessage,
              tree: treeSha,
              parents: [parentSha]
            });
            
            core.info(`New signed commit: ${newCommit.sha}`);
            
            // Force update the PR branch to point to the new signed commit
            await github.rest.git.updateRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `heads/${headRef}`,
              sha: newCommit.sha,
              force: true
            });
            
            core.info(`✓ Updated branch ${headRef} to signed commit ${newCommit.sha}`);
            
            // Add label to the PR
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              labels: ['release']
            });
            
            core.info(`✓ Added 'release' label to PR #${prNumber}`);

